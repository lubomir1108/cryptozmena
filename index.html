<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Arch√≠v Dediƒçstva ‚Äî Kapsula ƒåasu v. 10.1 (Kur√°torovan√© a Kompletn√©)</title>
<meta name="description" content="Zanechaj vetu pre bud√∫ce gener√°cie. Vytvor si Arch√≠v Dediƒçstva s trval√Ωm uchovan√≠m.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0a0a0a; 
    --bg2:#141414; 
    --card:#1c1c1c; 
    --accent:#b8860b; 
    --accent2:#daa520;
    --muted:#aaaaaa;
    --danger:#c94c4c; 
    --round:10px;
    --text:#f0f0f0;
    --gold:var(--accent);
    --gold-light:#e0b230;
    --delete-limit:rgba(201,76,76,0.2);
    --cta-bg:rgba(10,10,10,0.95);
  }
  
  h1, h3, .hero-text div:first-child {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
  }
  
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(ellipse at 10% 10%, rgba(184,134,11,0.1), transparent 10%), linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh; padding-bottom: 80px;}
  .wrap{max-width:1000px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:24px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:50px;height:50px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg1);font-size:20px;box-shadow:0 0 10px rgba(184,134,11,0.5);}
  h1{margin:0;font-size:28px}
  .subtitle{color:var(--muted);font-size:14px; margin-top: 4px;}

  .grid{display:grid;grid-template-columns:1fr 340px;gap:24px}
  @media(max-width:960px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);padding:20px;border-radius:var(--round);border:1px solid rgba(255,255,255,0.05);box-shadow:0 8px 30px rgba(0,0,0,0.4)}
  label{font-size:13px;color:var(--muted)}
  input[type="text"], textarea, select{width:100%;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:var(--text);margin-top:8px}
  textarea{min-height:90px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}

  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:var(--bg1);border:0;padding:12px 18px;border-radius:8px;cursor:pointer;font-weight:700;font-size:16px;box-shadow:0 4px 10px rgba(184,134,11,0.3); transition: all 0.3s;}
  .btn:hover {box-shadow:0 6px 15px rgba(184,134,11,0.5); transform: translateY(-1px);}
  .ghost{background:transparent;border:1px solid var(--muted);color:var(--muted);padding:12px 18px;border-radius:8px;cursor:pointer; transition: all 0.3s;}
  .ghost:hover {border-color:var(--text); color:var(--text);}
  
  .list{margin-top:12px;display:flex;flex-direction:column;gap:10px;max-height:600px;overflow-y:auto;} /* Povolen√© scroll */
  .item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;gap:12px;align-items:flex-start;justify-content:space-between;border:1px solid transparent;transition:all 0.3s;}
  .item:hover{background:rgba(255,255,255,0.04)}

  .highlight-paid{
    background:linear-gradient(180deg, rgba(184,134,11,0.1), rgba(184,134,11,0.05)) !important;
    border-color:var(--gold);
    box-shadow:0 0 0 1px var(--gold), 0 10px 30px rgba(184,134,11,0.15);
  }
  .tag-paid{background:linear-gradient(90deg,var(--accent),var(--accent2));color:var(--bg1);padding:4px 8px;border-radius:6px;font-weight:700;margin-left:8px;font-size:12px;letter-spacing:0.5px;}
  
  .item.temporary {
    border-left:4px solid var(--danger);
    opacity:0.75; 
    filter: none; 
    background:rgba(201,76,76,0.05);
  }
  .item.temporary:hover {opacity: 1.0; background:rgba(201,76,76,0.1);}

  .avatar {
    width:50px;height:50px;border-radius:8px;object-fit:cover;
    background: #444; /* Stabiln√© pozadie pre generovanie inici√°lok */
    color: white;
    font-weight: 700;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
  }

  .time-limit {
    font-weight:500;
    color:var(--danger);
    background-color:rgba(201,76,76,0.1); 
    padding:4px 8px;
    border-radius:4px;
    font-size:12px;
    margin-left:10px;
    border: 1px solid rgba(201,76,76,0.3);
  }

  /* CTA FOOTER DECENTN√ù */
  .sticky-cta {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: var(--cta-bg);
    box-shadow: 0 -4px 15px rgba(0,0,0,0.5);
    padding: 15px 20px; 
    display: flex; justify-content: center; align-items: center; gap: 20px;
    z-index: 1000;
    backdrop-filter: blur(8px);
    border-top: 1px solid rgba(184,134,11,0.2);
  }
  .sticky-cta .btn {
      padding: 14px 24px;
      animation: pulse-gold 3s infinite ease-in-out;
  }
  .cta-text {
      color: var(--muted); font-weight: 400; text-shadow: none; font-size: 15px;
  }
  .cta-text strong {color: var(--gold-light);}
  @keyframes pulse-gold {
    0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(184,134,11,0.4); }
    50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(184,134,11,0.7); }
  }

  /* ZV√ùRAZNENIE INTERAKCIE */
  .liked {color: #ff3838 !important; font-weight: 700;} 
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">Aƒå</div>
        <div>
          <h1 id="title">Arch√≠v Dediƒçstva</h1>
          <div id="subtitle" class="subtitle">Digit√°lna Kapsula ƒåasu v. 10.1 | Kur√°torovan√© a Kompletn√© Vydanie</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="lang">
          <button data-lang="sk" class="lang-btn active">SK</button>
          <button data-lang="en" class="lang-btn">EN</button>
          <button data-lang="de" class="lang-btn">DE</button>
          <button data-lang="cs" class="lang-btn">CZ</button>
        </div>
      </div>
    </header>

    <div class="hero">
        <span class="capsule-anim">üìú</span>
        <div class="hero-text">
            <div style="font-size:24px; font-weight:900; line-height:1.2;">UCHOVANIE ODKAZU PRE VEƒåNOS≈§</div>
            <div style="margin-top:12px; font-size:15px;">
                <span style="font-weight:700; color:var(--muted)">DOƒåASN√â (Prechodn√©):</span> Veta podlieha **Z√ÅNIKU** po 48 hodin√°ch. Dediƒçstvo prepad√°.
            </div>
            <div style="margin-top:4px; font-size:15px;">
                <span style="font-weight:700; color:var(--gold)">ARCH√çV DEDIƒåSTVA (1‚Ç¨ / Kur√°torovan√Ω Slot):</span> **TRVAL√â ULO≈ΩENIE**, Odznaky uchovan√©, Prioritn√Ω Status.
            </div>
        </div>
    </div>

    <div class="grid">
      <main>
        <div class="card">
          <h3 id="formTitle">Vytvori≈• a archivova≈• odkaz</h3>
          
          <div id="dailyLimitInfo" class="limit-info"></div>

          <label id="labelName">Meno / Prez√Ωvka (voliteƒæn√©)</label>
          <input id="author" type="text" placeholder="" />

          <label id="labelMessage" style="margin-top:12px">Arch√≠vny Vstup (max 300 znakov) <span id="charCount" class="char-count">0/300</span></label>
          <textarea id="message" maxlength="300" placeholder=""></textarea>

          <div style="margin-top:15px; padding:15px; background:rgba(184,134,11,0.03); border-radius:10px; border:1px solid var(--gold);">
            <div style="font-weight:700; color:var(--gold); margin-bottom:10px;">VOƒΩBA UCHOVANIA:</div>
            <div class="controls" style="margin-top:0;">
                <button id="payLinkBtn" class="btn">
                    üîí ZAPLA≈§ 1‚Ç¨ ‚Äî ARCH√çV DEDIƒåSTVA (Trval√© Ulo≈æenie)
                </button>
                <button id="saveFree" class="ghost">
                    Ulo≈æi≈• DOƒåASNE (48 hod√≠n)
                </button>
            </div>
          </div>
          <div class="small" style="margin-top:12px; color:var(--danger); font-weight:500;">
            *Doƒçasn√© vstupy bud√∫ po 48 hodin√°ch nav≈ædy odstr√°nen√©. Zachr√°≈à svoje Dediƒçstvo!
          </div>


          <div style="margin-top:25px">
            <label id="labelSearch">Prehƒæad a triedenie Arch√≠vu</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="search" type="text" placeholder="">
              <select id="sort">
                <option value="paid">DEDIƒåSTVO ARCH√çV najprv</option>
                <option value="new">Najnov≈°ie</option>
                <option value="likes">Najviac uzn√°van√©</option>
                <option value="views">Najviac ƒç√≠tan√©</option>
                <option value="old">Najstar≈°ie</option>
                <option value="random">N√°hodn√©</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 id="listTitle">Arch√≠vne Vstupy</h3>
            <div class="small" id="count">0 odkazov</div>
          </div>
          <div id="list" class="list" style="margin-top:10px">
            <div class="small">≈Ωiadne odkazy</div>
          </div>
        </div>
      </main>

      <aside>
        <div class="card">
          <h3 id="statsTitle">Metad√°ta Arch√≠vu</h3>
          <div class="small" style="margin-top:8px">Celkom Arch√≠vnych Vstupov: <strong id="statTotal">0</strong></div>
          <div class="small">Trvalo Uchovan√Ωch (DEDIƒåSTVO): <strong id="statPaid" style="color:var(--gold);font-weight:700">0</strong></div>
          <div class="small">Prechodn√© Vstupy (Zanikn√∫): <strong id="statTemporary" style="color:var(--danger);font-weight:700">0</strong></div>
          <div class="small">Kur√°torovan√° Hodnota (U≈°etren√©): <strong id="statSavedValue" style="color:#10b981;font-weight:700">0 ‚Ç¨</strong></div>
          <div class="small" style="margin-top:10px">Celkom ƒå√≠tan√≠: <strong id="statViews">0</strong></div>
          <div class="small">Celkom Uznan√≠ (Lajkov): <strong id="statLikes">0</strong></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 id="topTitle">Najviac Uzn√°van√© Dediƒçstvo</h3>
          <div id="topList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 id="helpTitle" style="color:var(--gold)">KUR√ÅTOROVAN√ù ARCH√çV</h3>
          <div class="small" id="helpText">
            Ka≈æd√Ω trvalo ulo≈æen√Ω odkaz (Arch√≠v Dediƒçstva) obdr≈æ√≠ unik√°tny **Odznak Uchovania (#)**, ktor√Ω odr√°≈æa jeho trval√© miesto v hist√≥rii. <br><br>
            <strong style="color:var(--danger)">Prechodn√Ω vstup</strong> bude vymazan√Ω po 48 hodin√°ch a **pr√≠de o mo≈ænos≈• z√≠ska≈• tento Odznak**.
            <br><br>
            <strong style="color:var(--gold)">Arch√≠v Dediƒçstva (1‚Ç¨ / Kur√°torovan√Ω Slot)</strong> zabezpeƒçuje uchovanie Odznaku a prioritn√© ƒç√≠tanie. Chr√°≈à svoje Dediƒçstvo pred Z√°nikom.
          </div>
        </div>
      </aside>
    </div>

    <footer>¬© 2025 Arch√≠v Dediƒçstva ‚Äî Kapsula ƒåasu v. 10.1 | Umeleck√° Schr√°nka pre V√°≈° Odkaz.</footer>

  </div>

  <div class="sticky-cta" id="stickyCta">
    <div class="cta-text" id="ctaText">
      ‚åõ V√°≈° odkaz je len **Prechodn√Ω**. Uchovajte svoje Dediƒçstvo natrvalo za **len 1‚Ç¨**!
    </div>
    <button id="stickyPayBtn" class="btn">
      ZABEZPEƒå ARCH√çV DEDIƒåSTVA (1‚Ç¨)
    </button>
  </div>

<script>
/* -----------------------
   KON≈†TANTY A GLOB√ÅLNY STAV
   ----------------------- */
const TEMP_DURATION_MS = 48 * 60 * 60 * 1000;
const DELETE_INTERVAL_MS = 60 * 60 * 1000;
const DAILY_FREE_LIMIT = 3; 
const MESSAGE_PRICE = 1.00; 
const STORAGE_KEY = 'odkaz_pre_ludstvo_v10';
const DAILY_LIMIT_KEY = 'op_daily_free_v10';
const LIKES_KEY = 'op_user_likes_v10'; // Nov√Ω kƒæ√∫ƒç pre ukladanie lajkov

// Denno-limitn√Ω stav
let dailyLimitState = loadDailyLimit();
let entries = loadEntries();
let userLikes = loadUserLikes(); // Naƒç√≠ta lajky pou≈æ√≠vateƒæa

const I18N = {
  sk: {
    title: 'Arch√≠v Dediƒçstva',
    subtitle: 'Digit√°lna Kapsula ƒåasu v. 10.1 | Kur√°torovan√© a Kompletn√© Vydanie',
    formTitle: 'Vytvori≈• a archivova≈• odkaz',
    labelName: 'Meno / Prez√Ωvka (voliteƒæn√©)',
    labelMessage: 'Arch√≠vny Vstup (max 300 znakov)',
    labelSearch: 'Prehƒæad a triedenie Arch√≠vu',
    listTitle: 'Arch√≠vne Vstupy',
    statsTitle: 'Metad√°ta Arch√≠vu',
    topTitle: 'Najviac Uzn√°van√© Dediƒçstvo',
    payLinkText: 'üîí ZAPLA≈§ 1‚Ç¨ ‚Äî ARCH√çV DEDIƒåSTVA (Trval√© Ulo≈æenie)',
    saveFree: 'Ulo≈æi≈• DOƒåASNE (48 hod√≠n)',
    placeholderMsg: 'Zanechaj stopu pre bud√∫cnos≈•, ne≈æ tvoja veta zanikne...',
    paidTag: 'DEDIƒåSTVO üìú',
    temporaryTag: (time) => `Z√°nik za ${time} üïØÔ∏è`,
    anonymous: 'Nezn√°my Autor',
    noResults: '≈Ωiadne vstupy v arch√≠ve',
    alertMessage: 'Arch√≠vny vstup nem√¥≈æe by≈• pr√°zdny!',
    alertMaxChars: 'Vstup je pr√≠li≈° rozsiahly. Max 300 znakov.',
    alertPayError: 'PLATOBN√ù LINK ch√Ωba. Simil√°cia Arch√≠vu Dediƒçstva? (OK = platen√©, Cancel = doƒçasn√©)',
    rank: 'Odznak Uchovania',
    shareText: 'Zdieƒæa≈• Vstup',
    ctaStickyText: '‚åõ V√°≈° odkaz je len **Prechodn√Ω**. Uchovajte svoje Dediƒçstvo natrvalo za **len 1‚Ç¨**!',
    ctaStickyBtn: 'ZABEZPEƒå ARCH√çV DEDIƒåSTVA (1‚Ç¨)',
    dailyLimitText: (remaining) => remaining > 0 
      ? `üóùÔ∏è KUR√ÅTOROVAN√ù SLOT D≈áA: Z√≠skaj TRVAL√ù ARCH√çV ZDARMA! Zost√°va **${remaining} Exkluz√≠vnych Slotov**!`
      : `üö´ Dne≈°n√Ω limit (${DAILY_FREE_LIMIT}) bol vyƒçerpan√Ω. Arch√≠v Dediƒçstva (Trval√© uchovanie) je dostupn√Ω za symbolick√© 1‚Ç¨!`,
    alertThanksFree: (savedValue) => `‚úÖ UZNANIE! V√°≈° vstup z√≠skal KUR√ÅTOROVAN√ù SLOT a bol ulo≈æen√Ω NATRVALO! U≈°etren√° Vn√≠man√° Hodnota: ${savedValue} ‚Ç¨! ≈†√≠rte odkaz!`,
    alertThanksTemporary: 'Vstup bol ulo≈æen√Ω ako PRECHODN√ù. Pripravte sa na Z√°nik po 48 hodin√°ch. Chcete riskova≈• stratu Dediƒçstva?'
  },
  en: { /* ... (rovnak√© ako V10.0) ... */ 
    title: 'Archive of Heritage',
    subtitle: 'Digital Time Capsule v. 10.1 | Curated and Complete Edition',
    saveFree: 'Save TEMPORARILY (48 hours)',
    paidTag: 'HERITAGE üìú',
    temporaryTag: (time) => `Expires in ${time} üïØÔ∏è`,
    anonymous: 'Unknown Author',
    dailyLimitText: (remaining) => remaining > 0 
      ? `üóùÔ∏è CURATED SLOT OF THE DAY: Get a PERMANENT ARCHIVE for FREE! **${remaining} Exclusive Slots Remaining**!`
      : `üö´ Today's limit (${DAILY_FREE_LIMIT}) has been reached. Heritage Archive (Permanent) is available for a symbolic ‚Ç¨1!`,
    alertThanksFree: (savedValue) => `‚úÖ ACCEPTED! Your entry earned a CURATED SLOT and has been stored PERMANENTLY! Saved Perceived Value: ${savedValue} ‚Ç¨! Spread the word!`,
    alertThanksTemporary: 'Entry stored as TEMPORARY. Prepare for Expiration in 48 hours. Risk losing your Heritage?'
  },
  de: { /* ... (rovnak√© ako V10.0) ... */ 
    title: 'Archiv des Erbes',
    subtitle: 'Digitale Zeitkapsel v. 10.1 | Kuratierte und Komplette Ausgabe',
    saveFree: 'Vor√ºbergehend speichern (48 Stunden)',
    paidTag: 'ERBE üìú',
    temporaryTag: (time) => `L√§uft ab in ${time} üïØÔ∏è`,
    anonymous: 'Unbekannter Autor',
    dailyLimitText: (remaining) => remaining > 0 
      ? `üóùÔ∏è KURATIERTER SLOT DES TAGES: Erhalten Sie ein PERMANENTES ARCHIV KOSTENLOS! **${remaining} Exklusive Slots** √ºbrig!`
      : `üö´ Das heutige Limit (${DAILY_FREE_LIMIT}) ist erreicht. Das Archiv des Erbes (Permanent) ist f√ºr symbolische 1‚Ç¨ verf√ºgbar!`,
    alertThanksFree: (savedValue) => `‚úÖ ANERKANNT! Ihr Eintrag hat einen KURATIERTEN SLOT erhalten und wurde DAUERHAFT gespeichert! Gesparter Wahrgenommener Wert: ${savedValue} ‚Ç¨! Teilen Sie die Botschaft!`,
    alertThanksTemporary: 'Eintrag als VOR√úBERGEHEND gespeichert. Bereiten Sie sich auf den Ablauf in 48 Stunden vor. M√∂chten Sie riskieren, Ihr Erbe zu verlieren?'
  },
  cs: { /* ... (rovnak√© ako V10.0) ... */ 
    title: 'Archiv Dƒõdictv√≠',
    subtitle: 'Digit√°ln√≠ Kapsle ƒåasu v. 10.1 | Kur√°torovan√© a Kompletn√≠ Vyd√°n√≠',
    saveFree: 'Ulo≈æit DOƒåASNƒö (48 hodin)',
    paidTag: 'DƒöDICTV√ç üìú',
    temporaryTag: (time) => `Z√°nik za ${time} üïØÔ∏è`,
    anonymous: 'Nezn√°m√Ω Autor',
    dailyLimitText: (remaining) => remaining > 0 
      ? `üóùÔ∏è KUR√ÅTOROVAN√ù SLOT DNE: Z√≠skej TRVAL√ù ARCHIV ZDARMA! Zb√Ωv√° **${remaining} Exkluzivn√≠ch Slot≈Ø**!`
      : `üö´ Dne≈°n√≠ limit (${DAILY_FREE_LIMIT}) byl vyƒçerp√°n. Archiv Dƒõdictv√≠ (Trval√© ulo≈æen√≠) je k dispozici za symbolick√© 1‚Ç¨!`,
    alertThanksFree: (savedValue) => `‚úÖ UZN√ÅN√ç! V√°≈° vstup z√≠skal KUR√ÅTOROVAN√ù SLOT a byl ulo≈æen NATRVALO! U≈°et≈ôen√° Vn√≠man√° Hodnota: ${savedValue} Kƒç! ≈†i≈ôte odkaz!`,
    alertThanksTemporary: 'Vstup byl ulo≈æen jako P≈òECHODN√ù. P≈ôipravte se na Z√°nik po 48 hodin√°ch. Chcete riskovat ztr√°tu Dƒõdictv√≠?'
  }
};


/* -----------------------
   LIMIT LOGIKA (Bez Zmien)
   ----------------------- */
function loadDailyLimit() {
    try {
        const raw = localStorage.getItem(DAILY_LIMIT_KEY);
        const state = raw ? JSON.parse(raw) : { count: 0, date: now() };
        
        const msPerDay = 24 * 60 * 60 * 1000;
        if (now() - state.date > msPerDay) {
            return { count: 0, date: now() }; 
        }
        return state;
    } catch (e) {
        return { count: 0, date: now() };
    }
}
function saveDailyLimit() {
    localStorage.setItem(DAILY_LIMIT_KEY, JSON.stringify(dailyLimitState));
}
function useFreeSlot() {
    if (dailyLimitState.count < DAILY_FREE_LIMIT) {
        dailyLimitState.count++;
        dailyLimitState.date = now(); 
        saveDailyLimit();
        return true;
    }
    return false;
}
function getRemainingFreeSlots() {
    dailyLimitState = loadDailyLimit();
    return DAILY_FREE_LIMIT - dailyLimitState.count;
}


/* -----------------------
   Lajky a Avatary
   ----------------------- */
function loadUserLikes() {
    try {
        const raw = localStorage.getItem(LIKES_KEY);
        // UserLikes je SET id odkazov, ktor√© pou≈æ√≠vateƒæ u≈æ lajkol
        return raw ? new Set(JSON.parse(raw)) : new Set();
    } catch (e) {
        return new Set();
    }
}
function saveUserLikes() {
    localStorage.setItem(LIKES_KEY, JSON.stringify(Array.from(userLikes)));
}

// Generovanie avataru z inici√°lok
function generateAvatar(author) {
    const name = author ? author.trim() : 'NA'; // Nezn√°my Autor
    const parts = name.split(' ');
    let initials = '';
    if (parts.length > 1) {
        initials = parts[0].charAt(0) + parts[parts.length - 1].charAt(0);
    } else if (parts[0].length > 0) {
        initials = parts[0].substring(0, 2);
    } else {
        initials = 'NA';
    }
    // Vr√°time inici√°lky, ktor√© sa zobrazia v HTML elemente (.avatar)
    return initials.toUpperCase();
}


/* -----------------------
   Helpers & DOM refs
   ----------------------- */
const el = id => document.getElementById(id);

const authorEl = el('author');
const messageEl = el('message');
const payLinkBtn = el('payLinkBtn');
const saveFree = el('saveFree');
const dailyLimitInfoEl = el('dailyLimitInfo');
const stickyPayBtn = el('stickyPayBtn');
const listEl = el('list');
const statTotal = el('statTotal');
const statPaid = el('statPaid');
const statTemporary = el('statTemporary');
const statViews = el('statViews');
const statLikes = el('statLikes');
const topList = el('topList');
const statSavedValue = el('statSavedValue'); 

let LANG = localStorage.getItem('op_lang') || 'sk';
applyLang(LANG);

/* -----------------------
   Utils
   ----------------------- */
function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,10); }
function now(){ return Date.now(); }
function getRemainingTime(ts){
    const remaining = (ts + TEMP_DURATION_MS) - now();
    if(remaining <= 0) return null;
    const h = Math.floor(remaining / (1000 * 60 * 60));
    const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    if(h > 0) return `${h}h ${m}m`;
    return `${m}m`;
}
function formatDate(ts){ return new Date(ts).toLocaleDateString(LANG, {year:'numeric',month:'short',day:'numeric'}); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&quot;',"'":'&#39;'})[c]); }
function truncate(s,n){ return s.length>n ? s.slice(0,n-1)+'‚Ä¶' : s; }
function simulateTranslation(text, targetLang) {
    if (targetLang === 'sk') return text;
    let emoji = '';
    let langName = '';
    if (targetLang === 'en') { emoji = 'üåç'; langName = 'ENG'; }
    else if (targetLang === 'de') { emoji = 'üè∞'; langName = 'DEU'; }
    else if (targetLang === 'cs') { emoji = 'üç∫'; langName = 'CZE'; }
    return `<span style="color:var(--muted); font-size:12px">${emoji} (${langName}) </span>` + text;
}


/* -----------------------
   Perzistencia
   ----------------------- */
function loadEntries(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    let loaded = raw ? JSON.parse(raw) : [];
    const filtered = loaded.filter(e => e.paid || (e.ts + TEMP_DURATION_MS > now()));
    if(filtered.length !== loaded.length) {
        entries = filtered;
        saveEntries();
    }
    return filtered;
  }catch(e){ console.error(e); return []; }
}
function saveEntries(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }
setInterval(loadEntries, DELETE_INTERVAL_MS);


/* -----------------------
   i18n & UI
   ----------------------- */
function applyLang(lang){
  LANG = lang;
  localStorage.setItem('op_lang', lang);
  const T = I18N[lang];
  
  const remaining = getRemainingFreeSlots();
  dailyLimitInfoEl.innerHTML = T.dailyLimitText(remaining).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  if (remaining > 0) {
      saveFree.textContent = `üçÄ Z√çSKAJ KUR√ÅTOROVAN√ù SLOT! (${remaining} ost√°va)`;
      saveFree.classList.add('free-slot-btn'); 
      saveFree.classList.remove('ghost');
  } else {
      saveFree.textContent = T.saveFree;
      saveFree.classList.remove('free-slot-btn');
      saveFree.classList.add('ghost');
  }

  const ctaPrice = LANG === 'cs' ? '25 Kƒç' : '1‚Ç¨';
  payLinkBtn.textContent = T.payLinkText.replace('1‚Ç¨', ctaPrice);
  stickyPayBtn.textContent = T.ctaStickyBtn.replace('1‚Ç¨', ctaPrice);
  el('ctaText').innerHTML = T.ctaStickyText.replace('1‚Ç¨', ctaPrice).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');


  el('title').textContent = T.title;
  el('subtitle').textContent = T.subtitle;
  el('formTitle').textContent = T.formTitle;
  el('labelName').textContent = T.labelName;
  el('labelMessage').textContent = T.labelMessage + ` (${messageEl.value.length}/300)`;
  el('sort').options[0].textContent = 'DEDIƒåSTVO ARCH√çV najprv'; // Oprava, preto≈æe i18n nezmenil OPTIONS

  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active', b.dataset.lang===lang));
  render();
}


/* -----------------------
   Render & UI
   ----------------------- */
function render(){
  const T = I18N[LANG];
  
  const q = (el('search').value || '').trim().toLowerCase();
  let list = entries.slice();
  list.forEach((e, i) => e.rank = i + 1);
  if(q) list = list.filter(e => (e.text + ' ' + (e.author||'')).toLowerCase().includes(q));
  
  // DOKONƒåEN√Å SORT LOGIKA
  const s = el('sort').value;
  if(s==='paid') list.sort((a,b)=> (b.paid?1:0) - (a.paid?1:0) || b.ts-a.ts);
  else if(s==='new') list.sort((a,b)=>b.ts-a.ts);
  else if(s==='old') list.sort((a,b)=>a.ts-b.ts);
  else if(s==='likes') list.sort((a,b)=>b.likes-a.likes || b.ts-a.ts);
  else if(s==='views') list.sort((a,b)=>b.views-a.views || b.ts-a.ts);
  else if(s==='random') list.sort(()=>Math.random()-0.5);

  listEl.innerHTML = '';
  if(list.length===0){
    listEl.innerHTML = `<div class="small">${T.noResults}</div>`;
  } else {
    list.forEach(e=>{
      const isTemporary = !e.paid;
      const remainingTime = isTemporary ? getRemainingTime(e.ts) : null;
      let displayedText = escapeHtml(e.text);
      const isLiked = userLikes.has(e.id); // Kontrola, ƒçi pou≈æ√≠vateƒæ lajkoval
      
      if (LANG !== 'sk' && isTemporary) {
          displayedText = simulateTranslation(displayedText, LANG);
      } else if (LANG !== 'sk' && e.paid) {
           displayedText = `<span style="color:var(--gold); font-size:12px">üìú (Original Text) </span>` + displayedText;
      }
      
      const item = document.createElement('div');
      item.className = 'item' + (e.paid ? ' highlight-paid' : '') + (isTemporary ? ' temporary' : '');
      item.dataset.id = e.id;
      item.innerHTML = `
        <div style="display:flex;gap:12px;align-items:flex-start;flex:1">
          <div class="avatar">${generateAvatar(e.author || T.anonymous)}</div>
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="font-weight:700">${escapeHtml(e.author||T.anonymous)}</div>
              <div class="meta">${formatDate(e.ts)}</div>
              <span class="meta" style="color:var(--accent2); font-weight:700;">#${e.rank}</span>
              ${e.paid?`<span class="tag-paid">${T.paidTag}</span>`:''}
              ${isTemporary?`<span class="time-limit">${T.temporaryTag(remainingTime || '0m')}</span>`:''}
            </div>
            <div style="margin-top:8px;font-size:15px">${displayedText}</div>
            <div style="margin-top:8px" class="meta">
              <span data-id="${e.id}" data-action="like" style="cursor:pointer;margin-right:8px" class="${isLiked ? 'liked' : ''}">‚ù§ ${e.likes}</span>
              <span>ƒå√≠tan√≠: ${e.views}</span>
              <button data-id="${e.id}" data-action="share" class="ghost" style="padding:4px 8px; margin-left:12px">${T.shareText}</button>
            </div>
          </div>
        </div>
      `;
      listEl.appendChild(item);
      // Zapoƒç√≠tavanie views sa vykon√° len raz na rel√°ciu
      if (!e.viewedInSession) {
          e.views = (e.views||0) + 1;
          e.viewedInSession = true;
      }
    });
    saveEntries();
  }

  // AKTUALIZ√ÅCIA ≈†TATIST√çK
  const paidCount = entries.filter(e=>e.paid).length;
  const tempCount = entries.filter(e=>!e.paid).length;
  const savedValue = paidCount * MESSAGE_PRICE; 
  
  statTotal.textContent = entries.length;
  statPaid.textContent = paidCount;
  statTemporary.textContent = tempCount;
  statViews.textContent = entries.reduce((s,e)=>s+(e.views||0),0);
  statLikes.textContent = entries.reduce((s,e)=>s+(e.likes||0),0);
  statSavedValue.textContent = `${savedValue.toFixed(2)} ‚Ç¨`; 
  el('count').textContent = list.length + ' ' + (LANG==='sk' || LANG==='cs' ? 'vstupov' : 'entries');

  // TOP LIST
  const top = entries.slice().sort((a,b)=>b.likes-a.likes).slice(0,5);
  topList.innerHTML = '';
  if(top.length===0) topList.innerHTML = '<div class="small">‚Äî</div>'
  else top.forEach(t=>{
    const d = document.createElement('div'); d.className='small';
    d.innerHTML = `<strong>#${t.rank} ${escapeHtml(t.author||T.anonymous)}</strong>: ${escapeHtml(truncate(t.text,60))} ‚Äî <span style="font-weight:700;color:var(--gold-light)">‚ù§ ${t.likes}</span>`;
    topList.appendChild(d);
  });
}


/* -----------------------
   Actions & Payment 
   ----------------------- */
function addEntry(asPaid, isFreeSlot = false){
  const T = I18N[LANG];
  const author = authorEl.value.trim() || null;
  const text = messageEl.value.trim();

  if(!text) return alert(T.alertMessage);
  if(text.length>300) return alert(T.alertMaxChars);

  const entry = {
    id: uid('o_'),
    author,
    text,
    ts: now(),
    likes: 0,
    views: 0,
    paid: Boolean(asPaid || isFreeSlot),
    avatarInitials: generateAvatar(author || T.anonymous) // Ulo≈æ√≠me inici√°lky pre konzistentnos≈•
  };
  entries.unshift(entry);
  saveEntries(); 
  
  authorEl.value=''; 
  messageEl.value='';
  el('charCount').textContent = `0/300`;
  applyLang(LANG); 
  
  if (isFreeSlot) {
      const savedValue = LANG === 'cs' ? '25 Kƒç' : '1.00'; 
      alert(T.alertThanksFree(savedValue));
  } else if (asPaid) {
      alert(T.alertThanksFree('1.00')); 
  } else {
      alert(T.alertThanksTemporary);
  }
}

const PAYMENT_LINK = ''; 
function handlePaymentAction(){
    const T = I18N[LANG];
    if(!messageEl.value.trim()) return alert(T.alertMessage);

    if(!PAYMENT_LINK){
        if(confirm(T.alertPayError)){
            addEntry(true); 
        }
        return;
    }
    window.open(PAYMENT_LINK, '_blank');
    if(confirm("Po dokonƒçen√≠ platby stlaƒç OK pre TRVAL√â UCHOVANIE ARCH√çVNEHO VSTUPU.")){
        addEntry(true);
    } 
}

function handleFreeAction(){
    const T = I18N[LANG];
    if(!messageEl.value.trim()) return alert(T.alertMessage);

    const remaining = getRemainingFreeSlots();
    if (remaining > 0) {
        if (confirm(`GRATULUJEME! V√°≈° vstup m√¥≈æe by≈• KUR√ÅTOROVAN√ù ZDARMA. Chcete vyu≈æi≈• jeden z ${remaining} Exkluz√≠vnych Slotov?`)) {
             useFreeSlot();
             addEntry(false, true); 
        }
    } else {
        if (confirm(`Limit (${DAILY_FREE_LIMIT}) pre Kur√°torovan√© Slot bol vyƒçerpan√Ω. Ulo≈æi≈• len PRECHODNE (48h) a riskova≈• Z√°nik Dediƒçstva?`)) {
            addEntry(false);
        }
    }
}


/* -----------------------
   Interaction Handler (Lajky/Zdieƒæanie)
   ----------------------- */
function handleInteraction(event) {
    const target = event.target.closest('[data-action]');
    if (!target) return;
    const action = target.dataset.action;
    const id = target.dataset.id;
    const entry = entries.find(e => e.id === id);

    if (!entry) return;

    if (action === 'like') {
        if (userLikes.has(id)) {
            // Un-like: M√¥≈æeme povoli≈•, ale v produkcii by sme to zva≈æovali. Pre t√∫to verziu nechajme len like.
            // entry.likes = Math.max(0, entry.likes - 1);
            // userLikes.delete(id);
            // alert('Uznanie u≈æ bolo udelen√©!');
            return;
        } else {
            entry.likes = (entry.likes || 0) + 1;
            userLikes.add(id);
            saveUserLikes(); 
            saveEntries();
            render(); 
        }
    } else if (action === 'share') {
        const shareText = `Pozrite si m√¥j ARCH√çV DEDIƒåSTVA - "${truncate(entry.text, 80)}" (#${entry.rank}). Pridajte svoj odkaz tu: ${window.location.href}`;
        if (navigator.share) {
            navigator.share({
                title: I18N[LANG].title,
                text: shareText,
                url: window.location.href,
            }).catch(error => console.log('Zdieƒæanie zru≈°en√©/zlyhalo', error));
        } else {
            navigator.clipboard.writeText(shareText);
            alert("Odkaz na Arch√≠v Dediƒçstva bol skop√≠rovan√Ω do schr√°nky!");
        }
    }
}


// Bindovanie na CTA tlaƒçidl√° a Event Listeners
payLinkBtn.addEventListener('click', handlePaymentAction);
stickyPayBtn.addEventListener('click', handlePaymentAction);
saveFree.addEventListener('click', handleFreeAction);
el('message').addEventListener('input', ()=> el('charCount').textContent = `${el('message').value.length}/300`);
el('sort').addEventListener('change', render);
el('search').addEventListener('input', render);

// Delegovan√Ω listener pre lajky a zdieƒæanie
listEl.addEventListener('click', handleInteraction);

/* -----------------------
   Init
   ----------------------- */
setInterval(loadEntries, DELETE_INTERVAL_MS); 
applyLang(LANG); 
</script>
</body>
</html>
